<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Éditeur Vidéo Avancé</title>
<style>
body { font-family: Arial; background: #f4f4f4; padding: 20px; }
.container { max-width: 800px; margin: 0 auto; }
input, button, textarea { margin: 5px 0; padding: 8px; width: 100%; }
video { width: 100%; margin-top: 10px; border: 1px solid #ccc; }
.clip { border: 1px solid #aaa; padding: 10px; margin-bottom: 10px; background: #fff; }
</style>
</head>
<body>
<div class="container">
  <h1>Mini Éditeur Vidéo Avancé</h1>

  <input type="file" id="videoInput" multiple />
  <div id="clips"></div>
  <button id="addClipsBtn">Ajouter les Clips</button>
  <button id="exportBtn">Exporter la Vidéo Finale</button>
  <video id="preview" controls></video>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.1/dist/ffmpeg.min.js"></script>
<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

const videoInput = document.getElementById('videoInput');
const clipsDiv = document.getElementById('clips');
const addClipsBtn = document.getElementById('addClipsBtn');
const exportBtn = document.getElementById('exportBtn');
const preview = document.getElementById('preview');

let clipFiles = [];

// Ajouter interface pour chaque clip
addClipsBtn.onclick = () => {
  clipsDiv.innerHTML = '';
  clipFiles = Array.from(videoInput.files);
  clipFiles.forEach((file, idx) => {
    const div = document.createElement('div');
    div.className = 'clip';
    div.innerHTML = `
      <strong>Clip ${idx + 1}: ${file.name}</strong><br>
      Début (s): <input type="number" min="0" value="0" id="start${idx}" /><br>
      Fin (s): <input type="number" min="1" value="10" id="end${idx}" /><br>
      Texte: <input type="text" id="text${idx}" placeholder="Texte à ajouter" />
    `;
    clipsDiv.appendChild(div);
  });
};

// Export vidéo
exportBtn.onclick = async () => {
  exportBtn.disabled = true;
  await ffmpeg.load();

  // Copier tous les fichiers dans FFmpeg
  for (let i = 0; i < clipFiles.length; i++) {
    ffmpeg.FS('writeFile', `clip${i}.mp4`, await fetchFile(clipFiles[i]));
  }

  let filterComplex = '';
  let concatList = [];
  for (let i = 0; i < clipFiles.length; i++) {
    const start = document.getElementById(`start${i}`).value || 0;
    const end = document.getElementById(`end${i}`).value || 10;
    const text = document.getElementById(`text${i}`).value || '';

    // Appliquer coupe + texte + fondu entrée/sortie
    const outputName = `out${i}.mp4`;
    let filters = `[0:v]trim=start=${start}:end=${end},fade=t=in:st=0:d=1,fade=t=out:st=${end-start-1}:d=1`;
    if(text) filters += `,drawtext=text='${text}':fontcolor=white:fontsize=24:x=(w-text_w)/2:y=(h-text_h)/2`;
    filters += `[v${i}];[0:a]atrim=start=${start}:end=${end},afade=t=in:st=0:d=1,afade=t=out:st=${end-start-1}:d=1[a${i}]`;

    filterComplex += filters + ';';
    concatList.push(`[v${i}][a${i}]`);
  }

  const concatStr = concatList.join('') + `concat=n=${clipFiles.length}:v=1:a=1[outv][outa]`;

  await ffmpeg.run(
    '-i', 'clip0.mp4', '-i', 'clip1.mp4', // à adapter selon nombre clips
    '-filter_complex', filterComplex + concatStr,
    '-map', '[outv]', '-map', '[outa]',
    'final.mp4'
  );

  const data = ffmpeg.FS('readFile', 'final.mp4');
  const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
  preview.src = url;
  exportBtn.disabled = false;
  alert('Export terminé !');
};
</script>
</body>
</html>
